<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autobotics | Dashboard</title>
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/dash_robotica.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
  <script src="js/rotaDash.js"></script>
</head>

<body>
  <aside>

        <section>
            <section class="menu-container">
                <img class="img-logo-curta" src="assets/logo/LOGO_CURTA.png" alt="">
                <h1>MENU</h1>

                <div class="paginas-container">

                    <div class="menu-dropdown-container">

                        <button class="a-pagina" onclick="menu(event)" id="selecionado" tag="agora">
                            <img class="icon-pagina" src="assets/icones/dash_icon.png" alt="">
                            Dashboards
                            <img class="icon-pagina" src="assets/icones/arrow_down.png" alt="">
                        </button>

                        
                        <div class="menu-dropdown-items" id="menuDropdown">
                        </div>
                    </div>


                    <a class="a-pagina" href="alerta.html">
                        <img class="icon-pagina" src="assets/icones/alerta_icon.png" alt="">
                        Alertas
                    </a>
                    <a class="a-pagina" href="parametros.html">
                        <img class="icon-pagina" src="assets/icones/parametros_icon.png" alt="">
                        Parâmetros
                    </a>

                    <a class="a-pagina" href="setor.html">
                        <img class="icon-pagina" src="assets/icones/setor_icon.png" alt="">
                        Setores
                    </a>
                    <a class="a-pagina" href="controladores.html">
                        <img class="icon-pagina" src="assets/icones/controlador_icon.png" alt="">
                        Controladores
                    </a>
                    <a class="a-pagina" href="funcionario.html">
                        <img class="icon-pagina" src="assets/icones/userImg.png" alt="">
                        Funcionários
                    </a>
                </div>
            </section>
            <a href="index.html">
                <button id="btn-sair" onclick="limparSessao()">
                    <img class="icon-sair" src="assets/icones/sair_icon.png" alt="">
                    Sair
                </button>
            </a>

    </aside>

  <section class="container-content">
    <div class="div-superior">
      <div class="div-filtro">
        <p>Controlador: </p>
        <select name="controlador" id="select-controlador" onchange="mudarControlador(this.value)">
          <option value="">Carregando...</option>
        </select>
        <p style="display: flex; justify-content: end; align-items: center; width: 70%; text-align: end;">Última atualização: <span id="ultima-atualizacao">--:--</span></p>
      </div>

      <div class="div-usuario">
        <div class="div-img-usuario">
          <img src="assets/icones/foto_usuario.png" alt="">
        </div>
        <div>
          <h6 id="nome-usuario"></h6>
          <p id="email-usuario"></p>
        </div>
      </div>
    </div>


    <div class="div-conteudo">
      <div class="container-conteudo">
        <div class="div-info-conteudo">
          <h3>Dashboard de Robótica tempo real</h3>
          <p id="data_atual"></p>
        </div>
        <div>
                <div id="criticidades-container" class="cards-criticidades">
              <div class="card-criticidade" id="card-critico">
                <p>CRÍTICO</p>
                <span style="color: #F44336;">Valor Limiar: --</span>
              </div>
              <div class="card-criticidade" id="card-medio">
                <p>MÉDIO</p>
                <span style="color: #e6ac00;">Valor Limiar: --</span>
              </div>
              <div class="card-criticidade" id="card-estavel">
                <p>ESTÁVEL</p>
                <span style="color: #4CAF50;">Abaixo de Limiar</span>
              </div>
            </div>
        <div class="div-metricas">
          <div class="doido">
            <!-- Cards de Criticidade acima de tudo -->
            

            <div class="div_grafico_alertas_processo">
              <div class="teste">
                <div class="card area-chart">
                  <h2>Últimos registros de uso dos componentes (%): </h2>
                  <canvas id="grafico_componentes" class="canvas-full"></canvas>
                </div>
              </div>
              <div class="cards-metricas">
                <div class="card-metrica">
                  <p>Pico de uso em CPU (Últimos registros):</p>
                  <span id="pico-cpu" style="color: #e6ac00;">--</span>
                </div>
                <div class="card-metrica">
                  <p style="text-align: center;">Uso de CPU (Média últimos registros): </p>
                  <span id="media-cpu" style="color: green;">--</span>
                </div>
                <div class="card-metrica">
                  <p>Disco restante:</p>
                  <span id="disco-gb" style="color: red;">--</span>
                </div>
              </div>
            </div>


            <div class="div_graficos">
              <div class="div_grafico">
                <p>CPU (%):</p>
                <canvas id="grafico_cpu"></canvas>
              </div>

              <div class="div_grafico">
                <p>RAM (%):</p>
                <canvas id="grafico_ram"></canvas>
              </div>

              <div class="div_grafico">
                <p>Utilização do Disco (%):</p>
                <canvas id="grafico_disco"></canvas>
              </div>

              <div class="card-processo">
                <h3>Processos consumindo <br>recursos:</h3>
                <div class="process-list" id="processList">
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
  </section>

</body>

<script src="js/rotaDash.js"></script>
<script src="js/robotica.js"></script>

<script>


  const dataAtual = new Date();
  const dia = dataAtual.getDate();
  const mes = dataAtual.getMonth() + 1;
  const ano = dataAtual.getFullYear();

  document.getElementById("data_atual").innerHTML = `Data: ${dia}/${mes}/${ano}`;

  document.getElementById("nome-usuario").innerHTML = sessionStorage.NOME_USUARIO;
  document.getElementById("email-usuario").innerHTML = sessionStorage.EMAIL_USUARIO;

  const COLORS = ['#4CAF50', '#e6ac00', '#F44336'];

  function index(perc) {
    return perc < 70 ? 0 : perc < 90 ? 1 : 2;
  }

  // cache global dos gráficos
let chartCPU = null;
let chartRAM = null;
let chartDISCO = null;


function criarGrafico(idCanvas, titulo, valor, cor, chave) {
  const data = {
    datasets: [{
      data: [valor, 100 - valor],
      centerColor: cor,
      borderColor: cor,
      backgroundColor: [cor, 'rgb(234, 234, 234)'],
      borderWidth: 0,
      centerInfo: null // { usedGB: number, totalGB: number }
    }]
  };

  const options = {
    aspectRatio: 2,
    cutout: '70%',
    circumference: 180,
    rotation: -90,
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false },
      title: { display: false }
    }
  };

  const centerPlugin = {
    id: 'valorCentral_' + chave,
    afterDraw(chart) {
      const { ctx, chartArea } = chart;
      if (!chartArea) return;

      const ds = chart.data.datasets[0];
      const useColor = ds.centerColor || cor;

      const centerX = (chartArea.left + chartArea.right) / 2;
      const centerY = (chartArea.top + chartArea.bottom) / 2 + (chartArea.bottom - chartArea.top) * 0.12;

      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = useColor;

      // Número principal: porcentagem
      const valorAtual = Number(ds.data[0]) || 0;
      ctx.font = 'bold 26px Jost, sans-serif';
      ctx.fillText(`${valorAtual.toFixed(1)}%`, centerX, centerY);

      // Linha secundária: depende do gráfico
      if (chave === "cpu") {
        // CPU → escreve apenas "CPU"
        ctx.font = '14px Jost, sans-serif';
        ctx.fillText("CPU", centerX, centerY + 28);
      } else {
        // RAM e Disco → usado / total em GB
        if (ds.centerInfo &&
            Number.isFinite(ds.centerInfo.usedGB) &&
            Number.isFinite(ds.centerInfo.totalGB) &&
            ds.centerInfo.totalGB > 0) {
          ctx.font = '14px Jost, sans-serif';
          ctx.fillText(
            `${ds.centerInfo.usedGB.toFixed(1)} GB / ${ds.centerInfo.totalGB.toFixed(1)} GB`,
            centerX,
            centerY + 28
          );
        }
      }

      ctx.restore();
    }
  };

  const ctx = document.getElementById(idCanvas);
  return new Chart(ctx, { type: 'doughnut', data, options, plugins: [centerPlugin] });
}



  //Nova dashboard
  const ctx1 = document.getElementById('grafico_componentes').getContext('2d');


  const horas = Array.from({ length: 7 }, (_, i) => `00:${i.toString().padStart(2, '0')}`);


  const dadosPorHora = {
    cpu: horas.map(() => Math.floor(Math.random() * (100 - 20 + 1) + 20)),
    ram: horas.map(() => Math.floor(Math.random() * (100 - 20 + 1) + 20)),
    disco: horas.map(() => Math.floor(Math.random() * (100 - 20 + 1) + 20))
  };

  const chartComponents = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: horas,
      datasets: [
        {
          label: 'CPU',
          data: dadosPorHora.cpu,
          borderColor: 'grey',
          backgroundColor: 'rgba(231,24,49,0.08)',
          fill: false,
          tension: 0.3
        },
        {
          label: 'RAM',
          data: dadosPorHora.ram,
          borderColor: '#890B59',
          backgroundColor: 'rgba(230,172,0,0.08)',
          fill: false,
          tension: 0.3
        },
        {
          label: 'Disco',
          data: dadosPorHora.disco,
          borderColor: '#0000FF',
          backgroundColor: 'rgba(76,175,80,0.08)',
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: {
          type: 'category',
          title: { display: true, text: 'Horário' },
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 }
        },
        y: {
          type: 'linear',
          beginAtZero: true,
          title: { display: true, text: 'Porcentagem de uso (%)' }
        }
      }
    }
  });

</script>

</html>