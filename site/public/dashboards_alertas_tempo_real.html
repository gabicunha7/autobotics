<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Autobotics | Dashboard</title>

  <link rel="stylesheet" href="css/sidebar.css" />
  <link rel="stylesheet" href="css/dash_alertas_tempo_real.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/rotaDash.js"></script>

  <!-- ANYCHART (Heatmap novo) -->
  <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-heatmap.min.js"></script>
</head>
<body>

<aside>
  <section>
    <section class="menu-container">
      <img class="img-logo-curta" src="assets/logo/LOGO_CURTA.png" alt="">
      <h1>MENU</h1>

      <div class="paginas-container">
        <div class="menu-dropdown-container">
          <button class="a-pagina" onclick="menu(event)" id="selecionado" tag="agora">
            <img class="icon-pagina" src="assets/icones/dash_icon.png" alt="">
            Dashboards
            <img class="icon-pagina" src="assets/icones/arrow_down.png" alt="">
          </button>
          <div class="menu-dropdown-items" id="menuDropdown"></div>
        </div>

        <a class="a-pagina" href="alerta.html">Alertas</a>
        <a class="a-pagina" href="parametros.html">Par√¢metros</a>
        <a class="a-pagina" href="setor.html">Setores</a>
        <a class="a-pagina" href="controladores.html">Controladores</a>
        <a class="a-pagina" href="funcionario.html">Funcion√°rios</a>
      </div>
    </section>

    <a href="index.html">
      <button id="btn-sair" onclick="limparSessao()">Sair</button>
    </a>
</aside>

<section class="container-content">

  <div class="div-superior">
    <div class="div-filtro">
      <p>Controlador:</p>
      <select>
        <option>Todos</option>
        <option>Controlador A</option>
        <option>Controlador B</option>
      </select>
    </div>

    <div class="div-usuario">
      <div class="div-img-usuario"><img src="assets/icones/foto_usuario.png"></div>
      <div>
        <h6 id="nome-usuario">Usu√°rio</h6>
        <p id="email-usuario">usuario@email.com</p>
      </div>
    </div>
  </div>

  <h1>Dashboard de Alertas em Tempo Real - Todos os Controladores</h1>

  <div class="div-conteudo">
    <div class="dashboard-wrapper">

      <!-- === ALTERA√á√ÉO M√çNIMA AQUI: KPI 1 COM 3 LINHAS (QUEBRA DE LINHA REAL) === -->
      <div class="card area-kpi1">
        <h4>Alertas Ativos no Setor</h4>
        <div class="kpi_dashboard">
          <div class="kpi-line"><span class="kpi-label">Total:</span> <span id="kpi_total">0</span></div>
          <div class="kpi-line"><span class="kpi-label">M√©dios:</span> <span id="kpi_medio">0</span></div>
          <div class="kpi-line"><span class="kpi-label">Cr√≠ticos:</span> <span id="kpi_critico">0</span></div>
        </div>
      </div>
      <!-- =================================================================== -->

      <div class="card area-kpi2">
        <h4>Alertas Resolvidos (hoje)</h4>
        <div class="kpi_dashboard"><p id="kpi_resolvidos">0</p></div>
      </div>

      <div class="card area-feed">
        <h2>Feed de Alertas</h2>
        <div class="feed" id="feed_area"></div>
      </div>

      <div class="card area-chart">
        <h2>Alertas por Componente</h2>
        <canvas id="grafico_componentes" class="canvas-full"></canvas>
      </div>

      <!-- ‚≠ê NOVO HEATMAP INTEGRADO -->
      <div class="card area-heatmap">
        <h2>Estabilidade dos Controladores</h2>
        <div id="container" style="height:100%; width:100%; min-height:260px;"></div>
      </div>

    </div>
  </div>

</section>

<script>
// DADOS USU√ÅRIO
document.getElementById('nome-usuario').innerText = sessionStorage.NOME_USUARIO || 'Usu√°rio';
document.getElementById('email-usuario').innerText = sessionStorage.EMAIL_USUARIO || 'usuario@email.com';

// FEED MOCK
const MOCK = {
  feed: [
    {time:'10:25', msg:'Alerta cr√≠tico de CPU (95%) - Controlador 0001', sev:'critico'},
    {time:'10:20', msg:'Alerta m√©dio de RAM (85%) - Controlador 0007', sev:'medio'},
    {time:'10:15', msg:'Alerta cr√≠tico de Disco resolvido - Controlador 0006', sev:'estavel'}
  ],
  counts: { critico: 6, medio: 5, estavel: 30 }
};

function renderFeed() {
  const feed = document.getElementById('feed_area');
  feed.innerHTML = '';
  MOCK.feed.forEach(it => {
    const div = document.createElement('div');
    div.className = 'feed-item ' + it.sev;
    div.innerHTML = `<div>${it.msg}</div><div>${it.time}</div>`;
    feed.appendChild(div);
  });
}

// === ALTERA√á√ÉO M√çNIMA NO JS: atualizar 3 campos ===
function renderKPIs() {
  // total = cr√≠ticos + m√©dios (mesma regra sua)
  const total = MOCK.counts.critico + MOCK.counts.medio;

  document.getElementById('kpi_total').innerText = total;
  document.getElementById('kpi_medio').innerText = MOCK.counts.medio;
  document.getElementById('kpi_critico').innerText = MOCK.counts.critico;

  document.getElementById('kpi_resolvidos').innerText = 19;
}
// ===================================================================

renderFeed();
renderKPIs();

// GRAFICO
const horas = Array.from({length: 24}, (_, i) => `${String(i).padStart(2,'0')}:00`);
new Chart(document.getElementById('grafico_componentes'), {
  type: 'line',
  data: {
    labels: horas,
    datasets: [
      { label:'CPU', data: horas.map(()=>Math.random()*30), borderColor:'#E71831' },
      { label:'RAM', data: horas.map(()=>Math.random()*20), borderColor:'#e6ac00' },
      { label:'Disco', data: horas.map(()=>Math.random()*10), borderColor:'#4CAF50' }
    ]
  }
});

// üî• HEATMAP ANYCHART
anychart.onDocumentReady(function () {
  var rawData = getData();
  var chart = anychart.heatMap(rawData);

  var colorScale = anychart.scales.ordinalColor();
  colorScale.ranges([
    { less: 800, color: "#4CAF50" },
    { from: 800, to: 1300, color: "#e6ac00" },
    { greater: 1300, color: "#E71831" }
  ]);

  chart.colorScale(colorScale);
  chart.labels(false);

  chart.tooltip().useHtml(true);
  chart.tooltip().titleFormat(function () {
    var v = this.heat;
    if (v < 800) return "Criticidade: Est√°vel";
    if (v <= 1300) return "Criticidade: M√©dio";
    return "Criticidade: Cr√≠tico";
  });

  chart.tooltip().format(function () {
    return "Hora: " + this.x + "<br>Controlador: " + this.y + "<br>Valor: " + this.heat;
  });

  chart.container("container");
  chart.draw();
});

// DADOS (mesmos que voc√™ enviou originalmente)
function getData() {
  return [
    {x:"10:00",y:"Controlador 0001",heat:700},
    {x:"10:00",y:"Controlador 0002",heat:713},
    {x:"10:00",y:"Controlador 0003",heat:657},
    {x:"10:00",y:"Controlador 0004",heat:957},
    {x:"10:00",y:"Controlador 0005",heat:1137},
    {x:"10:00",y:"Controlador 0006",heat:956},

    {x:"14:00",y:"Controlador 0001",heat:715},
    {x:"14:00",y:"Controlador 0002",heat:747},
    {x:"14:00",y:"Controlador 0003",heat:738},
    {x:"14:00",y:"Controlador 0004",heat:1056},
    {x:"14:00",y:"Controlador 0005",heat:1426},
    {x:"14:00",y:"Controlador 0006",heat:1631}
  ];
}
</script>

</body>
</html>
